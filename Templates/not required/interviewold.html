<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + JS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     
    <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!--  mic Icons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <style>
      
      video {
      object-fit: cover;
    }
    @layer utilities {
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }

      .no-scrollbar {
        -ms-overflow-style: none;
        /* IE and Edge */
        scrollbar-width: none;
        /* Firefox */
      }
    }
      .text-container {
        z-index: 100;
        width: 100vw;
        /* height: 100vh; */
        /* display: flex; */
        position: absolute;
        top: 0;
        left: 0;
        justify-content: center;
        align-items: center;
        /* font-size: 96px; */
        color: white;
        opacity: 0.8;
        user-select: none;
        text-shadow: 1px 1px rgba(0,0,0,0.1);
      }
      :root {
        --color-bg1: rgb(108, 0, 162);
        --color-bg2: rgb(0, 17, 82);
        --color1: 18, 113, 255;
        --color2: 221, 74, 255;
        --color3: 100, 220, 255;
        --color4: 200, 50, 50;
        --color5: 180, 180, 50;
        --color-interactive: 140, 100, 255;
        --circle-size: 80%;
        --blending: hard-light;
      }
      @keyframes moveInCircle {
        0% {
          transform: rotate(0deg);
        }
        50% {
          transform: rotate(180deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes moveVertical {
        0% {
          transform: translateY(-50%);
        }
        50% {
          transform: translateY(50%);
        }
        100% {
          transform: translateY(-50%);
        }
      }
      @keyframes moveHorizontal {
        0% {
          transform: translateX(-50%) translateY(-10%);
        }
        50% {
          transform: translateX(50%) translateY(10%);
        }
        100% {
          transform: translateX(-50%) translateY(-10%);
        }
      }
      .gradient-bg {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
        background: linear-gradient(40deg, var(--color-bg1), var(--color-bg2));
        top: 0;
        left: 0;
      }
      svg {
        display: none;
      }
      .gradients-container {
        filter: url(#goo) blur(40px);
        width: 100%;
        height: 100%;
      }
      .g1 {
        position: absolute;
        background: radial-gradient(circle at center, rgba(var(--color1), 0.8) 0, rgba(var(--color1), 0) 50%) no-repeat;
        mix-blend-mode: var(--blending);
        width: var(--circle-size);
        height: var(--circle-size);
        top: calc(50% - var(--circle-size) / 2);
        left: calc(50% - var(--circle-size) / 2);
        transform-origin: center center;
        animation: moveVertical 30s ease infinite;
        opacity: 1;
      }
      .g2 {
        position: absolute;
        background: radial-gradient(circle at center, rgba(var(--color2), 0.8) 0, rgba(var(--color2), 0) 50%) no-repeat;
        mix-blend-mode: var(--blending);
        width: var(--circle-size);
        height: var(--circle-size);
        top: calc(50% - var(--circle-size) / 2);
        left: calc(50% - var(--circle-size) / 2);
        transform-origin: calc(50% - 400px);
        animation: moveInCircle 20s reverse infinite;
        opacity: 1;
      }
      .g3 {
        position: absolute;
        background: radial-gradient(circle at center, rgba(var(--color3), 0.8) 0, rgba(var(--color3), 0) 50%) no-repeat;
        mix-blend-mode: var(--blending);
        width: var(--circle-size);
        height: var(--circle-size);
        top: calc(50% - var(--circle-size) / 2 + 200px);
        left: calc(50% - var(--circle-size) / 2 - 500px);
        transform-origin: calc(50% + 400px);
        animation: moveInCircle 40s linear infinite;
        opacity: 1;
      }
      .g4 {
        position: absolute;
        background: radial-gradient(circle at center, rgba(var(--color4), 0.8) 0, rgba(var(--color4), 0) 50%) no-repeat;
        mix-blend-mode: var(--blending);
        width: var(--circle-size);
        height: var(--circle-size);
        top: calc(50% - var(--circle-size) / 2);
        left: calc(50% - var(--circle-size) / 2);
        transform-origin: calc(50% - 200px);
        animation: moveHorizontal 40s ease infinite;
        opacity: 0.7;
      }
      .g5 {
        position: absolute;
        background: radial-gradient(circle at center, rgba(var(--color5), 0.8) 0, rgba(var(--color5), 0) 50%) no-repeat;
        mix-blend-mode: var(--blending);
        width: calc(var(--circle-size) * 2);
        height: calc(var(--circle-size) * 2);
        top: calc(50% - var(--circle-size));
        left: calc(50% - var(--circle-size));
        transform-origin: calc(50% - 800px) calc(50% + 200px);
        animation: moveInCircle 20s ease infinite;
        opacity: 1;
      }
      .interactive {
        position: absolute;
        background: radial-gradient(circle at center, rgba(var(--color-interactive), 0.8) 0, rgba(var(--color-interactive), 0) 50%) no-repeat;
        mix-blend-mode: var(--blending);
        width: 100%;
        height: 100%;
        top: -50%;
        left: -50%;
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <div class="text-container bg-transparent min-h-screen flex flex-col">
      <!-- Main Container -->
  <div class="flex-1 container mx-auto pt-4 flex flex-col space-y-4 text-sm md:text-base">
    <!-- Text Section -->
    <div class="messages no-scrollbar flex-1 overflow-y-auto p-4 max-h-[26rem] md:max-h-[27rem]" id="messagesContainer">
  
    </div>
  </div>

  <!-- Camera Section (Responsive) -->
  <div class="relative w-full h-32 flex items-center justify-between">
    <!-- Image -->
    <div
      class="bg-white absolute right-20 w-28 h-28 flex items-center justify-center rounded-full shadow-md hidden sm:block" style="display:flex; align-items: center; justify-content: center; background-color: aliceblue; border: 5px solid rgb(197, 211, 255); font-size: 30px; color: royalblue; font-weight: bolder;">
      <span class="text-center">AI</span>
    </div>

    <!-- Video -->
    <video id="videoElement" class="absolute left-20 w-[200px] h-full rounded-lg shadow-md" autoplay></video>
  </div>

  <!-- Footer Section (Always at the bottom) -->
  <div
    class="footer bg-white/20 backdrop-blur-lg border border-white/30 shadow-2xl rounded-xl text-white py-4 w-[95%] md:w-[90%] flex justify-between items-center px-6 md:px-14 mt-4 mx-auto mb-8"
    style="box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2)">
    <div class="info">
      <span class="text-sm md:text-lg font-bold text-black">Evalio</span>
    </div>

    <!-- Middle Mic Icon -->
    <div class="mic-icon flex justify-center cursor-pointer" onclick="speechrecog()">
      <!-- Default Mic Off Icon -->
      <i id="micIcon" class="fa-solid fa-microphone-slash text-red-600 text-2xl"></i>
    </div>

    <a href="/interview/feedback/"><button
      class="leave-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded text-xs md:text-base">
      Leave interview
    </button></a>
  </div>


    </div>
    <div class="gradient-bg">
      <svg xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="goo">
            <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
            <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -8" result="goo" />
            <feBlend in="SourceGraphic" in2="goo" />
          </filter>
        </defs>
      </svg>
      <div class="gradients-container">
        <div class="g1"></div>
        <div class="g2"></div>
        <div class="g3"></div>
        <div class="g4"></div>
        <div class="g5"></div>
        <div class="interactive"></div>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const interBubble = document.querySelector('.interactive');
        let curX = 0;
        let curY = 0;
        let tgX = 0;
        let tgY = 0;
    
        function move() {
          curX += (tgX - curX) / 20;
          curY += (tgY - curY) / 20;
          interBubble.style.transform = `translate(${Math.round(curX)}px, ${Math.round(curY)}px)`;
          requestAnimationFrame(move);
        }
    
        window.addEventListener('mousemove', (event) => {
          tgX = event.clientX;
          tgY = event.clientY;
        });
    
        move();
      });
    </script>
     <script>
      // Camera access code
      const videoElement = document.getElementById("videoElement");
      if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then(function (stream) {
            videoElement.srcObject = stream;
          })
          .catch(function (error) {
            console.log("Something went wrong accessing the camera!");
          });
      }
    </script>
    <script>
      /*---------------------SPEECH RECOG.--------------------------*/
      /*************************************************/
      // Function to get CSRF token from cookies
      function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          // console.log("Cookies available: ", document.cookie); // Log all cookies
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  // console.log("Found cookie: ", cookieValue); // Log the found cookie value
                  break;
              }
          }
      }
      return cookieValue;
  }
  
      // ************************************************************************
      function speak(aiSpeech) {
              // Create a new SpeechSynthesisUtterance instance
              const utterance = new SpeechSynthesisUtterance(aiSpeech);
  
              // Optional: Set properties for the speech
              utterance.lang = 'en-US'; // Language
              utterance.pitch = 1.2;       // Pitch (0 to 2)
              utterance.rate = 1;        // Rate (0.1 to 10)
  
              // Speak the text
              window.speechSynthesis.speak(utterance);
          }
      //*************************************************************************
      function speechrecog() {
        const micIcon = document.getElementById("micIcon");
        const micText = document.getElementById("micText");
      
        console.log("yep listening...");
        let recognization = new webkitSpeechRecognition();
      
        recognization.onstart = () => {
          console.log("Started Listening");
          micIcon.classList.remove("fa-microphone-slash", "text-red-600");
          micIcon.classList.add(
            "bx",
            "bx-dots-horizontal-rounded",
            "bx-flashing",
            "text-blue-600",
            "text-4xl"
          );
          micText.textContent = "Mic on";
        };
      
        recognization.onresult = (e) => {
          var transcript = e.results[0][0].transcript;
          console.log("Transcript: " + transcript);
      
          const csrftoken = getCookie('csrftoken');
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/tool/', true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.setRequestHeader('X-CSRFToken', csrftoken);
      
          xhr.onload = function () {
            if (xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              console.log("response: ", JSON.stringify(response, null, 2));
      
              // Update chat with previous transcripts
              const messagesContainer = document.getElementById("messagesContainer");
              messagesContainer.innerHTML = ''; // Clear existing messages
      
              // Loop through all transcripts and responses from the server
              response.transcripts.forEach((item) => {
                // Append each transcript and response
                const userMessage = document.createElement("div");
                userMessage.classList.add("bg-gray-100", "p-4", "rounded-lg", "shadow-md", "mb-2", "w-fit", "font-semibold");
                userMessage.innerHTML = `<p class="text-left text-gray-700">You: ${item.transcript}</p>`;
                messagesContainer.appendChild(userMessage);
      
                const aiMessage = document.createElement("div");
                aiMessage.classList.add("bg-blue-100", "p-4", "rounded-lg", "shadow-md", "mb-2", "w-fit", "ml-auto");
                aiMessage.innerHTML = `<p class="text-left text-gray-700">AI: ${item.response}</p>`;
                console.log("Ai Message Transcript:-> "+item.response);
                messagesContainer.appendChild(aiMessage);
                console.log("Ai Message:-> "+aiMessage);
                lastAiResponse = item.response; // Update lastAiResponse with the current AI response
              });
              // After the loop, lastAiResponse will hold the last AI response
              console.log("Last AI Response: ", lastAiResponse);
              //Calling the Speech Function for Ai Transcript
              speak(lastAiResponse);
  
              // Scroll to the bottom of the messages container
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
              console.log("Error: " + xhr.statusText);
            }
          };
      
          xhr.send(JSON.stringify({ transcript: transcript }));
        };
      
        recognization.onend = function () {
          console.log('Speech recognition service disconnected');
          micIcon.classList.remove(
            "bx",
            "bx-dots-horizontal-rounded",
            "bx-flashing",
            "text-blue-600",
            "text-4xl"
          );
          micIcon.classList.add(
            "fa-solid",
            "fa-microphone-slash",
            "text-red-600",
            "text-2xl"
          );
          micText.textContent = "Open mic";
        };
      
        recognization.start();
      }
      
      /*-----------------------------------------------------------------------*/
    </script>
    <script type="text/javascript">
      const csrftoken = '{{ csrf_token }}'; // This will set the CSRF token
      document.cookie = "csrftoken=" + csrftoken; // Optional: Set it manually
  </script>
  </body>
</html>
